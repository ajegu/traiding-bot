# Task 1.2 - Tables DynamoDB (trades, bot_config, reports)

## Statut : Terminé

## Objectif

Créer les tables DynamoDB nécessaires au fonctionnement du bot de trading :
- **trades** : Historique de toutes les transactions
- **bot_config** : Configuration du bot (stratégie, symbole, état actif/inactif)
- **reports** : Archivage des rapports quotidiens

## Contexte

Ces tables sont essentielles pour :
- Stocker l'historique des trades pour le calcul du P&L
- Persister la configuration du bot entre les exécutions
- Archiver les rapports quotidiens pour analyse historique

## Contraintes

- **Free Tier obligatoire** : Mode `PAY_PER_REQUEST` (on-demand) pour rester dans les limites gratuites
- Région : `eu-west-3` (Paris)
- Chiffrement activé par défaut (AES-256)
- Design Single-Table recommandé pour optimiser les coûts

## Architecture des Tables

### 1. Table `trades`

Stocke l'historique complet des transactions.

#### Clés Principales

| Attribut | Type | Description |
|----------|------|-------------|
| `pk` | String (Hash Key) | Partition Key - Format : `TRADE#{uuid}` |
| `sk` | String (Range Key) | Sort Key - Format : `METADATA` ou `UPDATE#{timestamp}` |

#### Attributs

| Attribut | Type | Description | Exemple |
|----------|------|-------------|---------|
| `id` | String | UUID du trade | `550e8400-e29b-41d4-a716-446655440000` |
| `order_id` | Number | ID ordre Binance | `123456789` |
| `client_order_id` | String | ID client unique | `bot_1701864615_abc123` |
| `symbol` | String | Paire de trading | `BTCUSDT` |
| `side` | String | Direction | `BUY` / `SELL` |
| `type` | String | Type d'ordre | `MARKET` / `LIMIT` |
| `status` | String | Statut | `FILLED` / `CANCELLED` / `ERROR` |
| `quantity` | Number | Quantité exécutée | `0.001` |
| `price` | Number | Prix d'exécution | `42500.00` |
| `quote_quantity` | Number | Montant total USDT | `42.50` |
| `commission` | Number | Frais | `0.0425` |
| `commission_asset` | String | Devise des frais | `USDT` / `BNB` |
| `strategy` | String | Stratégie utilisée | `rsi` / `ma` / `combined` |
| `indicators` | Map | Indicateurs au moment du trade | `{"rsi": 28.5, "ma50": 41200}` |
| `pnl` | Number | Profit/Loss (si vente) | `15.50` |
| `pnl_percent` | Number | P&L en pourcentage | `1.65` |
| `related_trade_id` | String | Trade lié (achat/vente) | UUID |
| `created_at` | String | Date création (ISO 8601) | `2024-12-06T10:30:15Z` |
| `updated_at` | String | Dernière MAJ (ISO 8601) | `2024-12-06T10:30:16Z` |
| `gsi1pk` | String | GSI1 Partition Key | `SYMBOL#BTCUSDT` |
| `gsi1sk` | String | GSI1 Sort Key | `2024-12-06T10:30:15Z` |
| `gsi2pk` | String | GSI2 Partition Key | `DATE#2024-12-06` |
| `gsi2sk` | String | GSI2 Sort Key | `2024-12-06T10:30:15Z` |
| `gsi3pk` | String | GSI3 Partition Key | `STATUS#FILLED` |
| `gsi3sk` | String | GSI3 Sort Key | `2024-12-06T10:30:15Z` |

#### Global Secondary Indexes (GSI)

| GSI | Partition Key | Sort Key | Projection | Usage |
|-----|---------------|----------|------------|-------|
| `gsi1-symbol-date` | `gsi1pk` | `gsi1sk` | ALL | Trades par symbole |
| `gsi2-date` | `gsi2pk` | `gsi2sk` | ALL | Trades par date |
| `gsi3-status` | `gsi3pk` | `gsi3sk` | ALL | Trades par statut |

### 2. Table `bot_config`

Stocke la configuration du bot et son état.

#### Clés Principales

| Attribut | Type | Description |
|----------|------|-------------|
| `pk` | String (Hash Key) | Partition Key - Format : `CONFIG#{type}` |
| `sk` | String (Range Key) | Sort Key - Format : `SETTINGS` ou `HISTORY#{timestamp}` |

#### Configuration Principale (`pk = CONFIG#bot`, `sk = SETTINGS`)

| Attribut | Type | Description | Valeur par défaut |
|----------|------|-------------|-------------------|
| `enabled` | Boolean | Bot actif ou non | `false` |
| `strategy` | String | Stratégie active | `rsi` |
| `symbol` | String | Paire de trading | `BTCUSDT` |
| `amount` | Number | Montant par trade (USDT) | `100` |
| `rsi_period` | Number | Période RSI | `14` |
| `rsi_oversold` | Number | Seuil survente | `30` |
| `rsi_overbought` | Number | Seuil surachat | `70` |
| `ma_short` | Number | Période MA courte | `50` |
| `ma_long` | Number | Période MA longue | `200` |
| `last_execution` | String | Dernière exécution (ISO 8601) | `null` |
| `last_signal` | String | Dernier signal | `HOLD` |
| `created_at` | String | Date création | ISO 8601 |
| `updated_at` | String | Dernière MAJ | ISO 8601 |

#### Limites de Sécurité (`pk = CONFIG#limits`, `sk = SETTINGS`)

| Attribut | Type | Description | Valeur par défaut |
|----------|------|-------------|-------------------|
| `max_trades_per_day` | Number | Max trades/jour | `50` |
| `max_amount_per_trade` | Number | Max montant/trade | `1000` |
| `cooldown_minutes` | Number | Cooldown entre trades | `5` |
| `max_drawdown_percent` | Number | Max drawdown | `10` |

### 3. Table `reports`

Stocke l'historique des rapports quotidiens.

#### Clés Principales

| Attribut | Type | Description |
|----------|------|-------------|
| `pk` | String (Hash Key) | Partition Key - Format : `REPORT#{YYYY-MM-DD}` |
| `sk` | String (Range Key) | Sort Key - Format : `DAILY` |

#### Attributs

| Attribut | Type | Description |
|----------|------|-------------|
| `date` | String | Date du rapport (YYYY-MM-DD) |
| `trades_count` | Number | Nombre de trades |
| `buy_count` | Number | Nombre d'achats |
| `sell_count` | Number | Nombre de ventes |
| `pnl_absolute` | Number | P&L en USDT |
| `pnl_percent` | Number | P&L en pourcentage |
| `total_volume` | Number | Volume total tradé |
| `total_fees` | Number | Total des frais |
| `total_balance_usdt` | Number | Valeur portefeuille |
| `balances` | Map | Soldes par devise |
| `telegram_message_id` | Number | ID message Telegram |
| `status` | String | Statut envoi | `sent` / `pending` / `failed` |
| `created_at` | String | Date création (ISO 8601) |
| `ttl` | Number | Expiration (Unix timestamp, 90 jours) |

#### GSI pour requêtes par mois

| GSI | Partition Key | Sort Key | Usage |
|-----|---------------|----------|-------|
| `gsi1-month` | `gsi1pk` (MONTH#YYYY-MM) | `gsi1sk` (date) | Rapports par mois |

## Actions à Réaliser

### 1. Créer le module Terraform DynamoDB

#### 1.1 Fichier `terraform/modules/dynamodb/variables.tf`

```hcl
variable "environment" {
  description = "Environnement de déploiement"
  type        = string
}

variable "project_name" {
  description = "Nom du projet"
  type        = string
}

variable "common_tags" {
  description = "Tags communs à appliquer"
  type        = map(string)
  default     = {}
}
```

#### 1.2 Fichier `terraform/modules/dynamodb/main.tf`

```hcl
locals {
  name_prefix = "${var.project_name}-${var.environment}"
}

# =============================================================================
# Table: Trades
# =============================================================================
resource "aws_dynamodb_table" "trades" {
  name         = "${local.name_prefix}-trades"
  billing_mode = "PAY_PER_REQUEST"  # Free Tier compatible
  hash_key     = "pk"
  range_key    = "sk"

  attribute {
    name = "pk"
    type = "S"
  }

  attribute {
    name = "sk"
    type = "S"
  }

  attribute {
    name = "gsi1pk"
    type = "S"
  }

  attribute {
    name = "gsi1sk"
    type = "S"
  }

  attribute {
    name = "gsi2pk"
    type = "S"
  }

  attribute {
    name = "gsi2sk"
    type = "S"
  }

  attribute {
    name = "gsi3pk"
    type = "S"
  }

  attribute {
    name = "gsi3sk"
    type = "S"
  }

  # GSI1: Trades par symbole
  global_secondary_index {
    name            = "gsi1-symbol-date"
    hash_key        = "gsi1pk"
    range_key       = "gsi1sk"
    projection_type = "ALL"
  }

  # GSI2: Trades par date
  global_secondary_index {
    name            = "gsi2-date"
    hash_key        = "gsi2pk"
    range_key       = "gsi2sk"
    projection_type = "ALL"
  }

  # GSI3: Trades par statut
  global_secondary_index {
    name            = "gsi3-status"
    hash_key        = "gsi3pk"
    range_key       = "gsi3sk"
    projection_type = "ALL"
  }

  point_in_time_recovery {
    enabled = var.environment == "prod"
  }

  server_side_encryption {
    enabled = true
  }

  tags = merge(var.common_tags, {
    Name = "${local.name_prefix}-trades"
  })
}

# =============================================================================
# Table: Bot Config
# =============================================================================
resource "aws_dynamodb_table" "bot_config" {
  name         = "${local.name_prefix}-bot-config"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "pk"
  range_key    = "sk"

  attribute {
    name = "pk"
    type = "S"
  }

  attribute {
    name = "sk"
    type = "S"
  }

  point_in_time_recovery {
    enabled = var.environment == "prod"
  }

  server_side_encryption {
    enabled = true
  }

  tags = merge(var.common_tags, {
    Name = "${local.name_prefix}-bot-config"
  })
}

# =============================================================================
# Table: Reports
# =============================================================================
resource "aws_dynamodb_table" "reports" {
  name         = "${local.name_prefix}-reports"
  billing_mode = "PAY_PER_REQUEST"
  hash_key     = "pk"
  range_key    = "sk"

  attribute {
    name = "pk"
    type = "S"
  }

  attribute {
    name = "sk"
    type = "S"
  }

  attribute {
    name = "gsi1pk"
    type = "S"
  }

  attribute {
    name = "gsi1sk"
    type = "S"
  }

  # GSI1: Rapports par mois
  global_secondary_index {
    name            = "gsi1-month"
    hash_key        = "gsi1pk"
    range_key       = "gsi1sk"
    projection_type = "ALL"
  }

  # TTL pour expiration automatique des anciens rapports
  ttl {
    attribute_name = "ttl"
    enabled        = true
  }

  point_in_time_recovery {
    enabled = var.environment == "prod"
  }

  server_side_encryption {
    enabled = true
  }

  tags = merge(var.common_tags, {
    Name = "${local.name_prefix}-reports"
  })
}
```

#### 1.3 Fichier `terraform/modules/dynamodb/outputs.tf`

```hcl
# =============================================================================
# Trades Table Outputs
# =============================================================================
output "trades_table_name" {
  description = "Nom de la table trades"
  value       = aws_dynamodb_table.trades.name
}

output "trades_table_arn" {
  description = "ARN de la table trades"
  value       = aws_dynamodb_table.trades.arn
}

# =============================================================================
# Bot Config Table Outputs
# =============================================================================
output "bot_config_table_name" {
  description = "Nom de la table bot_config"
  value       = aws_dynamodb_table.bot_config.name
}

output "bot_config_table_arn" {
  description = "ARN de la table bot_config"
  value       = aws_dynamodb_table.bot_config.arn
}

# =============================================================================
# Reports Table Outputs
# =============================================================================
output "reports_table_name" {
  description = "Nom de la table reports"
  value       = aws_dynamodb_table.reports.name
}

output "reports_table_arn" {
  description = "ARN de la table reports"
  value       = aws_dynamodb_table.reports.arn
}

# =============================================================================
# Combined Outputs
# =============================================================================
output "all_table_arns" {
  description = "Liste de tous les ARNs des tables"
  value = [
    aws_dynamodb_table.trades.arn,
    aws_dynamodb_table.bot_config.arn,
    aws_dynamodb_table.reports.arn
  ]
}

output "all_table_names" {
  description = "Map de tous les noms des tables"
  value = {
    trades     = aws_dynamodb_table.trades.name
    bot_config = aws_dynamodb_table.bot_config.name
    reports    = aws_dynamodb_table.reports.name
  }
}
```

### 2. Intégrer le module dans la configuration principale

#### 2.1 Modifier `terraform/main.tf`

Ajouter l'appel au module DynamoDB :

```hcl
# =============================================================================
# DynamoDB Tables
# =============================================================================
module "dynamodb" {
  source = "./modules/dynamodb"

  environment  = var.environment
  project_name = var.project_name
  common_tags  = local.common_tags
}
```

#### 2.2 Ajouter les outputs dans `terraform/outputs.tf`

```hcl
# =============================================================================
# DynamoDB Outputs
# =============================================================================
output "dynamodb_trades_table_name" {
  description = "Nom de la table trades"
  value       = module.dynamodb.trades_table_name
}

output "dynamodb_trades_table_arn" {
  description = "ARN de la table trades"
  value       = module.dynamodb.trades_table_arn
}

output "dynamodb_bot_config_table_name" {
  description = "Nom de la table bot_config"
  value       = module.dynamodb.bot_config_table_name
}

output "dynamodb_bot_config_table_arn" {
  description = "ARN de la table bot_config"
  value       = module.dynamodb.bot_config_table_arn
}

output "dynamodb_reports_table_name" {
  description = "Nom de la table reports"
  value       = module.dynamodb.reports_table_name
}

output "dynamodb_reports_table_arn" {
  description = "ARN de la table reports"
  value       = module.dynamodb.reports_table_arn
}

output "dynamodb_all_table_arns" {
  description = "Liste de tous les ARNs des tables DynamoDB"
  value       = module.dynamodb.all_table_arns
}
```

### 3. Déployer les tables

```bash
cd terraform

# Initialiser (si pas déjà fait)
terraform init

# Valider la syntaxe
terraform validate

# Voir le plan d'exécution
terraform plan

# Appliquer les changements
terraform apply
```

### 4. Vérification post-déploiement

```bash
# Lister les tables créées
aws dynamodb list-tables --profile trading-bot-dev

# Vérifier la structure de la table trades
aws dynamodb describe-table \
  --table-name trading-bot-dev-trades \
  --profile trading-bot-dev

# Insérer un item de test dans bot_config
aws dynamodb put-item \
  --table-name trading-bot-dev-bot-config \
  --item '{
    "pk": {"S": "CONFIG#bot"},
    "sk": {"S": "SETTINGS"},
    "enabled": {"BOOL": false},
    "strategy": {"S": "rsi"},
    "symbol": {"S": "BTCUSDT"},
    "amount": {"N": "100"},
    "created_at": {"S": "2024-12-07T00:00:00Z"}
  }' \
  --profile trading-bot-dev

# Vérifier l'insertion
aws dynamodb get-item \
  --table-name trading-bot-dev-bot-config \
  --key '{"pk": {"S": "CONFIG#bot"}, "sk": {"S": "SETTINGS"}}' \
  --profile trading-bot-dev
```

## Checklist

- [ ] Créer le dossier `terraform/modules/dynamodb/`
- [ ] Créer `terraform/modules/dynamodb/variables.tf`
- [ ] Créer `terraform/modules/dynamodb/main.tf`
- [ ] Créer `terraform/modules/dynamodb/outputs.tf`
- [ ] Modifier `terraform/main.tf` pour inclure le module
- [ ] Modifier `terraform/outputs.tf` pour exposer les outputs
- [ ] Exécuter `terraform init`
- [ ] Exécuter `terraform validate`
- [ ] Exécuter `terraform plan`
- [ ] Exécuter `terraform apply`
- [ ] Vérifier la création des tables dans la console AWS
- [ ] Tester l'insertion d'un item de configuration
- [ ] Tester les requêtes sur les GSI

## Ressources AWS Créées

| Ressource | Nom | Description |
|-----------|-----|-------------|
| DynamoDB Table | `trading-bot-{env}-trades` | Historique des trades |
| DynamoDB Table | `trading-bot-{env}-bot-config` | Configuration du bot |
| DynamoDB Table | `trading-bot-{env}-reports` | Rapports quotidiens |

## Coûts Free Tier

| Ressource | Limite Free Tier | Usage Estimé |
|-----------|------------------|--------------|
| Stockage | 25 GB | < 1 GB |
| RCU (on-demand) | 25 unités | < 25 |
| WCU (on-demand) | 25 unités | < 25 |

## Notes Importantes

1. **Mode PAY_PER_REQUEST** : Pas de provisionnement de capacité, facturation à l'usage (compatible Free Tier)
2. **Point-in-time Recovery** : Activé uniquement en production pour économiser les coûts
3. **TTL sur reports** : Les rapports expirent après 90 jours pour limiter le stockage
4. **Chiffrement** : SSE activé par défaut (AES-256, géré par AWS)
5. **GSI** : 3 index sur trades pour les requêtes fréquentes (par symbole, date, statut)

## Prochaine Étape

Une fois cette tâche terminée, passer à l'étape **1.3 - SSM Parameter Store**.
